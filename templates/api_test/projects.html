{% extends "base.html" %}

{% block content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">接口测试项目管理</h2>
        <div class="card-actions">
            <div class="search-box">
                <input type="text" id="projectSearch" placeholder="搜索项目名称..."
                       onkeyup="filterProjects()">
                <i class="fas fa-search"></i>
            </div>
            {% if user_role in ['admin', 'operator'] %}
            <button class="btn btn-primary" onclick="showModal('addProjectModal')">
                <i class="fas fa-plus"></i> 新增项目
            </button>
            {% endif %}
        </div>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>项目名称</th>
                    <th>版本号</th>
                    <th>状态</th>
                    <th>创建时间</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="projectsTableBody">
                {% for project in projects %}
                <tr>
                    <td>
                        <a href="{{ url_for('get_project', project_id=project.id) }}" class="link-primary">
                            {{ project.name }}
                        </a>
                    </td>
                    <td>{{ project.version }}</td>
                    <td>
                        <span class="status-badge {{ 'status-active' if project.status == 'active' else 'status-inactive' }}">
                            {{ '启用' if project.status == 'active' else '禁用' }}
                        </span>
                    </td>
                    <td>{{ project.created_at }}</td>
                    <td class="actions-cell">
                        <button class="btn btn-outline btn-sm"
                                onclick="editProject('{{ project.id }}', '{{ project.name }}', '{{ project.version }}', '{{ project.description }}')">
                            <i class="fas fa-edit"></i> 编辑
                        </button>
                        <button class="btn btn-{{ 'danger' if project.status == 'active' else 'success' }} btn-sm"
                                onclick="toggleProjectStatus('{{ project.id }}', '{{ project.status }}')">
                            <i class="fas fa-{{ 'ban' if project.status == 'active' else 'check' }}"></i>
                            {{ '禁用' if project.status == 'active' else '启用' }}
                        </button>
                        <button class="btn btn-danger btn-sm"
                                onclick="deleteProject('{{ project.id }}', '{{ project.name }}')">
                            <i class="fas fa-trash"></i> 删除
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="5" style="text-align: center; padding: 30px;">
                        <i class="fas fa-info-circle" style="font-size: 24px; color: #999; margin-bottom: 10px;"></i>
                        <p>暂无项目数据，请点击"新增项目"按钮创建</p>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- 添加/编辑项目模态框 -->
<div class="modal-backdrop" id="addProjectModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="projectModalTitle">添加项目</h3>
            <button class="modal-close" onclick="hideModal('addProjectModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="projectForm">
                <input type="hidden" id="projectId">
                <div class="form-group">
                    <label class="form-label" for="projectName">项目名称 <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="projectName" required
                           placeholder="请输入项目名称">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectVersion">版本号</label>
                    <input type="text" class="form-control" id="projectVersion" value="1.0"
                           placeholder="请输入版本号">
                </div>
                <div class="form-group">
                    <label class="form-label" for="projectDescription">描述</label>
                    <textarea class="form-control" id="projectDescription" rows="3"
                              placeholder="请输入项目描述"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="hideModal('addProjectModal')">取消</button>
                    <button type="submit" class="btn btn-primary">提交</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 过滤项目列表
    function filterProjects() {
        const searchTerm = document.getElementById('projectSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#projectsTableBody tr');

        rows.forEach(row => {
            const projectName = row.querySelector('td:first-child').textContent.toLowerCase();
            row.style.display = projectName.includes(searchTerm) ? '' : 'none';
        });
    }

    // 显示添加项目模态框
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }

    // 隐藏模态框
    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // 编辑项目
    function editProject(id, name, version, description) {
        document.getElementById('projectModalTitle').textContent = '编辑项目';
        document.getElementById('projectId').value = id;
        document.getElementById('projectName').value = name;
        document.getElementById('projectVersion').value = version;
        document.getElementById('projectDescription').value = description;
        showModal('addProjectModal');
    }

    // 提交项目表单
    document.getElementById('projectForm').addEventListener('submit', function(e) {
        e.preventDefault();

        const id = document.getElementById('projectId').value;
        const name = document.getElementById('projectName').value.trim();
        const version = document.getElementById('projectVersion').value.trim();
        const description = document.getElementById('projectDescription').value.trim();

        if (!name) {
            alert('项目名称不能为空');
            return;
        }

        const url = id ?
            `/api_test/projects/${id}` :
            '/api_test/projects';
        const method = id ? 'PUT' : 'POST';

        // 构建请求数据
        const data = { name, version, description };

        fetch(url, {
            method: method,
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(data)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message || (id ? '项目更新成功' : '项目创建成功'));
                window.location.reload();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            alert('请求失败: ' + error.message);
        });
    });

    // 切换项目状态
    function toggleProjectStatus(projectId, currentStatus) {
        if (!confirm(`确定要${currentStatus === 'active' ? '禁用' : '启用'}该项目吗？`)) {
            return;
        }

        fetch(`/api_test/projects/${projectId}/status`, {
            method: 'PATCH',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        });
    }

    // 删除项目
    function deleteProject(projectId, projectName) {
        if (!confirm(`确定要删除项目"${projectName}"吗？此操作不可撤销！`)) {
            return;
        }

        fetch(`/api_test/projects/${projectId}`, {
            method: 'DELETE',
            headers: {
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        });
    }
</script>
{% endblock %}