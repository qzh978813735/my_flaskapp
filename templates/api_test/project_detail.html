{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <h1>项目: {{ project.name }} <small>v{{ project.version }}</small></h1>
    <p>{{ project.description }}</p>
</div>

<div class="tabs-container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('groups')">用例组管理</div>
        <div class="tab" onclick="switchTab('variables')">
            <a href="{{ url_for('get_global_variables', project_id=project.id) }}">全局参数配置</a>
        </div>
        <div class="tab" onclick="switchTab('tasks')">
            <a href="{{ url_for('get_scheduled_tasks', project_id=project.id) }}">定时任务</a>
        </div>
        <div class="tab" onclick="switchTab('reports')">
            <a href="{{ url_for('get_test_reports', project_id=project.id, type='manual') }}">测试报告</a>
        </div>
    </div>
</div>

<div id="groupsTab" class="tab-content active">
    <div class="card">
        <div class="card-header">
            <h2 class="card-title">接口用例组列表</h2>
            <div class="card-actions">
                <div class="search-box">
                    <input type="text" id="groupSearch" placeholder="搜索用例组名称..." 
                           onkeyup="filterGroups()">
                    <i class="fas fa-search"></i>
                </div>
                <button class="btn btn-primary" onclick="showModal('addGroupModal')">
                    <i class="fas fa-plus"></i> 新增用例组
                </button>
            </div>
        </div>
        <div class="card-body">
            <table class="data-table">
                <thead>
                    <tr>
                        <th style="width: 20px;"><input type="checkbox" id="selectAllGroups"></th>
                        <th>用例组名称</th>
                        <th>优先级</th>
                        <th>所属服务</th>
                        <th>状态</th>
                        <th>创建时间</th>
                        <th>操作</th>
                    </tr>
                </thead>
                <tbody id="groupsTableBody">
                    {% for group in groups %}
                    <tr>
                        <td><input type="checkbox" class="group-checkbox" value="{{ group.id }}"></td>
                        <td>
                            <a href="{{ url_for('get_test_cases', group_id=group.id) }}" class="link-primary">
                                {{ group.name }}
                            </a>
                        </td>
                        <td>
                            <span class="priority-badge priority-{{ group.priority|lower }}">
                                {{ group.priority }}
                            </span>
                        </td>
                        <td>{{ group.service or '-' }}</td>
                        <td>
                            <span class="status-badge {{ 'status-active' if group.status == 'active' else 'status-inactive' }}">
                                {{ '启用' if group.status == 'active' else '禁用' }}
                            </span>
                        </td>
                        <td>{{ group.created_at }}</td>
                        <td class="actions-cell">
                            <button class="btn btn-outline btn-sm" 
                                    onclick="editGroup('{{ group.id }}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-{{ 'danger' if group.status == 'active' else 'success' }} btn-sm"
                                    onclick="toggleGroupStatus('{{ group.id }}', '{{ group.status }}')">
                                <i class="fas fa-{{ 'ban' if group.status == 'active' else 'check' }}"></i> 
                                {{ '禁用' if group.status == 'active' else '启用' }}
                            </button>
                            <button class="btn btn-outline btn-sm" 
                                    onclick="copyGroup('{{ group.id }}', '{{ group.name }}')">
                                <i class="fas fa-copy"></i> 复制
                            </button>
                            <button class="btn btn-danger btn-sm" 
                                    onclick="deleteGroup('{{ group.id }}', '{{ group.name }}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                    {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <i class="fas fa-info-circle" style="font-size: 24px; color: #999; margin-bottom: 10px;"></i>
                            <p>暂无用例组数据，请点击"新增用例组"按钮创建</p>
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if groups %}
            <div class="batch-actions" style="margin-top: 15px;">
                <button class="btn btn-outline" onclick="exportSelectedGroups()">
                    <i class="fas fa-download"></i> 导出选中用例组
                </button>
            </div>
            {% endif %}
        </div>
    </div>
</div>

<!-- 添加/编辑用例组模态框 -->
<div class="modal-backdrop" id="addGroupModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="groupModalTitle">添加用例组</h3>
            <button class="modal-close" onclick="hideModal('addGroupModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="groupForm" method="post" action="{{ url_for('create_test_group', project_id=project.id) }}">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <input type="hidden" id="groupId" name="group_id">
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="groupName">用例组名称 <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="groupName" name="name" required 
                               placeholder="请输入用例组名称">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="groupPriority">优先级 <span style="color: red;">*</span></label>
                        <select class="form-select" id="groupPriority" name="priority" required>
                            <option value="P1">P1（高）</option>
                            <option value="P2" selected>P2（中）</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="groupService">所属服务</label>
                    <input type="text" class="form-control" id="groupService" name="service"
                           placeholder="请输入所属服务">
                </div>
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="groupSprint">Sprint</label>
                        <input type="text" class="form-control" id="groupSprint" name="sprint"
                               placeholder="例如：Sprint 1.0">
                    </div>
                    <div class="form-group">
                        <label class="form-label" for="groupStoryId">Story ID</label>
                        <input type="text" class="form-control" id="groupStoryId" name="story_id"
                               placeholder="请输入Story ID">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label" for="groupTestCaseId">TestCase ID</label>
                    <input type="text" class="form-control" id="groupTestCaseId" name="test_case_id"
                           placeholder="请输入TestCase ID">
                </div>
                <div class="form-group">
                    <label class="form-label" for="groupDescription">描述</label>
                    <textarea class="form-control" id="groupDescription" name="description" rows="3"
                              placeholder="请输入用例组描述"></textarea>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="hideModal('addGroupModal')">取消</button>
                    <button type="submit" class="btn btn-primary">提交</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 全选/取消全选
    document.getElementById('selectAllGroups').addEventListener('change', function() {
        const checkboxes = document.querySelectorAll('.group-checkbox');
        checkboxes.forEach(checkbox => {
            checkbox.checked = this.checked;
        });
    });
    
    // 过滤用例组列表
    function filterGroups() {
        const searchTerm = document.getElementById('groupSearch').value.toLowerCase();
        const rows = document.querySelectorAll('#groupsTableBody tr');
        
        rows.forEach(row => {
            const groupName = row.querySelector('td:nth-child(2)').textContent.toLowerCase();
            row.style.display = groupName.includes(searchTerm) ? '' : 'none';
        });
    }
    
    // 显示/隐藏模态框
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'flex';
    }
    
    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }
    
    // 复制用例组
    function copyGroup(groupId, groupName) {
        if (!confirm(`确定要复制用例组"${groupName}"吗？`)) {
            return;
        }
        
        fetch(`/api_test/groups/${groupId}/copy`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            }
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert(data.message);
                window.location.reload();
            } else {
                alert('操作失败: ' + (data.message || '未知错误'));
            }
        });
    }
    
    // 导出选中的用例组
    function exportSelectedGroups() {
        const selectedIds = Array.from(document.querySelectorAll('.group-checkbox:checked'))
            .map(checkbox => checkbox.value);
            
        if (selectedIds.length === 0) {
            alert('请先选择要导出的用例组');
            return;
        }
        
        // 构建导出URL
        const url = new URL(`{{ url_for('create_test_group', project_id=project.id) }}/export`, window.location.origin);
        selectedIds.forEach(id => url.searchParams.append('group_ids', id));
        
        // 触发下载
        window.location.href = url.toString();
    }
    
    // 其他功能实现...
</script>
{% endblock %}