{% extends "base.html" %}

{% block content %}
<div class="page-header">
    <div class="page-path">
        <a href="{{ url_for('api_test') }}">项目管理</a> &gt;
        <a href="{{ url_for('get_project', project_id=project.id) }}">{{ project.name }}</a> &gt;
        <a href="{{ url_for('get_test_cases', group_id=group.id) }}">{{ group.name }}</a> &gt;
        <span>{{ case.name }}</span>
    </div>
    <div class="page-actions">
        <button class="btn btn-primary" onclick="saveTestCase()">
            <i class="fas fa-save"></i> 保存
        </button>
        <button class="btn btn-outline" onclick="executeTestCase()">
            <i class="fas fa-play"></i> 执行测试
        </button>
    </div>
</div>

<div class="tabs-container">
    <div class="tabs">
        <div class="tab active" onclick="switchTab('basic')">基本信息</div>
        <div class="tab" onclick="switchTab('initialization')">数据初始化</div>
        <div class="tab" onclick="switchTab('headers')">请求头部</div>
        <div class="tab" onclick="switchTab('params')">请求参数</div>
        <div class="tab" onclick="switchTab('variables')">结果变量</div>
        <div class="tab" onclick="switchTab('validations')">结果校验</div>
    </div>
</div>

<!-- 基本信息 -->
<div id="basicTab" class="tab-content active">
    <div class="card">
        <div class="card-body">
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="caseName">用例名称 <span style="color: red;">*</span></label>
                    <input type="text" class="form-control" id="caseName" value="{{ case.name }}"
                           placeholder="请输入用例名称">
                </div>
                <div class="form-group">
                    <label class="form-label" for="caseMethod">请求方法 <span style="color: red;">*</span></label>
                    <select class="form-select" id="caseMethod">
                        <option value="GET" {{ 'selected' if case.method == 'GET' else '' }}>GET</option>
                        <option value="POST" {{ 'selected' if case.method == 'POST' else '' }}>POST</option>
                        <option value="PUT" {{ 'selected' if case.method == 'PUT' else '' }}>PUT</option>
                        <option value="DELETE" {{ 'selected' if case.method == 'DELETE' else '' }}>DELETE</option>
                        <option value="PATCH" {{ 'selected' if case.method == 'PATCH' else '' }}>PATCH</option>
                    </select>
                </div>
            </div>
            
            <div class="form-grid">
                <div class="form-group">
                    <label class="form-label" for="caseProtocol">协议</label>
                    <select class="form-select" id="caseProtocol">
                        <option value="HTTP" {{ 'selected' if case.protocol == 'HTTP' else '' }}>HTTP</option>
                        <option value="HTTPS" {{ 'selected' if case.protocol == 'HTTPS' else '' }}>HTTPS</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label" for="caseDomain">域名</label>
                    <input type="text" class="form-control" id="caseDomain" value="{{ case.domain }}"
                           placeholder="例如：http://api.test.com (为空则使用环境配置的域名)">
                </div>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="caseRoute">路由 <span style="color: red;">*</span></label>
                <input type="text" class="form-control" id="caseRoute" value="{{ case.route }}"
                       placeholder="例如：/api/user/login (支持参数替换，格式为 ${paramName})">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="caseService">所属服务</label>
                <input type="text" class="form-control" id="caseService" value="{{ case.service }}"
                       placeholder="当环境配置域名包含${service}时为必填项">
            </div>
            
            <div class="form-group">
                <label class="form-label" for="caseDescription">描述</label>
                <textarea class="form-control" id="caseDescription" rows="3"
                          placeholder="请输入用例描述">{{ case.description }}</textarea>
            </div>
            
            <div class="form-check">
                <label class="form-check-label">
                    <input type="checkbox" id="caseClearCookies" {{ 'checked' if case.clear_cookies else '' }}>
                    请求前清空Cookies
                </label>
            </div>
        </div>
    </div>
</div>

<!-- 请求参数 -->
<div id="paramsTab" class="tab-content">
    <div class="card">
        <div class="card-header">
            <h3 class="card-title">请求参数设置</h3>
        </div>
        <div class="card-body">
            <div class="form-group">
                <label class="form-label" for="paramType">参数类型</label>
                <select class="form-select" id="paramType" onchange="updateParamEditor()">
                    <option value="raw" {{ 'selected' if case.params.type == 'raw' else '' }}>raw (application/json)</option>
                    <option value="form" {{ 'selected' if case.params.type == 'form' else '' }}>form (application/x-www-form-urlencoded)</option>
                    <option value="file" {{ 'selected' if case.params.type == 'file' else '' }}>file (multipart/form-data)</option>
                </select>
            </div>
            
            <div id="rawParamOptions" style="margin: 10px 0;">
                <div class="form-check">
                    <label class="form-check-label">
                        <input type="checkbox" id="isJsonArray"> 是否JSON数组
                    </label>
                </div>
            </div>
            
            <div id="fileParamOptions" style="margin: 10px 0; display: none;">
                <div class="form-group">
                    <label class="form-label" for="filePath">文件路径</label>
                    <input type="text" class="form-control" id="filePath" 
                           placeholder="请输入文件绝对路径，如：/data/files/test.jpg">
                </div>
                <small style="color: #666;">提示：参数内容中请填写其他表单字段，格式为JSON</small>
            </div>
            
            <div class="form-group">
                <label class="form-label" for="paramContent">参数内容</label>
                <textarea class="form-control code-editor" id="paramContent" rows="10"
                          placeholder="请输入参数内容">{{ case.params.content }}</textarea>
                <small style="color: #666; margin-top: 5px; display: block;">
                    提示：支持参数替换，变量格式为 ${paramName}
                </small>
            </div>
        </div>
    </div>
</div>

<!-- 其他标签页内容省略 -->

<script>
    // 切换标签页
    function switchTab(tabName) {
        // 隐藏所有标签内容
        document.querySelectorAll('.tab-content').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // 移除所有标签的active类
        document.querySelectorAll('.tab').forEach(tab => {
            tab.classList.remove('active');
        });
        
        // 显示选中的标签内容和激活标签
        document.getElementById(`${tabName}Tab`).classList.add('active');
        document.querySelector(`.tab[onclick="switchTab('${tabName}')"]`).classList.add('active');
    }
    
    // 更新参数编辑器显示
    function updateParamEditor() {
        const type = document.getElementById('paramType').value;
        
        document.getElementById('rawParamOptions').style.display = type === 'raw' ? 'block' : 'none';
        document.getElementById('fileParamOptions').style.display = type === 'file' ? 'block' : 'none';
    }
    
    // 保存接口用例
    function saveTestCase() {
        // 收集基本信息
        const basicData = {
            name: document.getElementById('caseName').value.trim(),
            method: document.getElementById('caseMethod').value,
            protocol: document.getElementById('caseProtocol').value,
            domain: document.getElementById('caseDomain').value.trim(),
            route: document.getElementById('caseRoute').value.trim(),
            service: document.getElementById('caseService').value.trim(),
            description: document.getElementById('caseDescription').value.trim(),
            clear_cookies: document.getElementById('caseClearCookies').checked
        };
        
        // 验证必填字段
        if (!basicData.name) {
            alert('用例名称不能为空');
            return;
        }
        
        if (!basicData.route) {
            alert('路由不能为空');
            return;
        }
        
        // 收集请求参数
        const paramData = {
            type: document.getElementById('paramType').value,
            content: document.getElementById('paramContent').value
        };
        
        // 构建完整数据对象
        const caseData = {
            ...basicData,
            params: paramData
            // 其他标签页数据...
        };
        
        fetch(`/api_test/cases/{{ case.id }}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify(caseData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                alert('用例保存成功');
            } else {
                alert('保存失败: ' + (data.message || '未知错误'));
            }
        })
        .catch(error => {
            alert('请求失败: ' + error.message);
        });
    }
    
    // 执行接口用例
    function executeTestCase() {
        const envSelect = confirm('请选择测试环境:\n1. 开发环境\n2. 测试环境');
        const envId = envSelect ? 'env1' : 'env2';
        
        fetch(`/api_test/cases/{{ case.id }}/execute`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': document.querySelector('input[name="csrf_token"]').value
            },
            body: JSON.stringify({ env_id: envId })
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // 显示执行结果
                showExecutionResult(data.result);
            } else {
                alert('执行失败: ' + (data.message || '未知错误'));
            }
        });
    }
    
    // 显示执行结果
    function showExecutionResult(result) {
        // 创建结果弹窗
        const resultHtml = `
            <div class="execution-result-modal">
                <div class="modal-header">
                    <h3>执行结果 - ${result.status === 'passed' ? '通过' : '失败'}</h3>
                    <button onclick="this.closest('.execution-result-modal').remove()">&times;</button>
                </div>
                <div class="modal-body">
                    <div class="result-section">
                        <h4>基本信息</h4>
                        <p>用例名称: {{ case.name }}</p>
                        <p>请求URL: ${result.request_url}</p>
                        <p>请求方法: ${result.request_method}</p>
                        <p>开始时间: ${result.start_time}</p>
                        <p>耗时: ${result.duration.toFixed(2)}ms</p>
                        <p>状态码: ${result.response_status}</p>
                        <p>测试结果: <span class="status-badge status-${result.status}">${result.status === 'passed' ? '通过' : '失败'}</span></p>
                    </div>
                    
                    <div class="result-section">
                        <h4>请求参数</h4>
                        <pre>${JSON.stringify(result.request_params, null, 2)}</pre>
                    </div>
                    
                    <div class="result-section">
                        <h4>响应结果</h4>
                        <pre>${result.response_body}</pre>
                    </div>
                </div>
            </div>
        `;
        
        document.body.insertAdjacentHTML('beforeend', resultHtml);
    }
</script>
{% endblock %}