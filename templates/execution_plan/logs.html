{% extends "execution_plan/base.html" %}

{% block content %}
<!-- 操作日志页面 -->
<div class="card">
    <div class="card-header">
        <h2 class="card-title">执行计划日志</h2>
        <div class="filter-controls">
            <form method="get" id="filterForm" style="display: flex; gap: 10px; align-items: center;">
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="plan_id">计划：</label>
                    <select class="form-select" id="plan_id" name="plan_id" onchange="document.getElementById('filterForm').submit()">
                        <option value="">所有计划</option>
                        {% for plan in plans %}
                        <option value="{{ plan.id }}" {% if current_plan_id == plan.id %}selected{% endif %}>
                            {{ plan.name }}
                        </option>
                        {% endfor %}
                    </select>
                </div>
                
                <div style="display: flex; align-items: center; gap: 5px;">
                    <label for="status">状态：</label>
                    <select class="form-select" id="status" name="status" onchange="document.getElementById('filterForm').submit()">
                        <option value="">所有状态</option>
                        <option value="success" {% if current_status == 'success' %}selected{% endif %}>成功</option>
                        <option value="failed" {% if current_status == 'failed' %}selected{% endif %}>失败</option>
                        <option value="running" {% if current_status == 'running' %}selected{% endif %}>执行中</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-outline" onclick="resetFilters()">
                    <i class="fas fa-times"></i> 重置
                </button>
            </form>
        </div>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>执行ID</th>
                    <th>计划名称</th>
                    <th>执行者</th>
                    <th>开始时间</th>
                    <th>完成时间</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% if logs %}
                    {% for log in logs %}
                    <tr>
                        <td>{{ log.id }}</td>
                        <td>{{ log.plan_name }}</td>
                        <td>{{ log.executed_by }}</td>
                        <td>{{ log.started_at }}</td>
                        <td>{{ log.completed_at or '-' }}</td>
                        <td>
                            <span class="status-badge {{ 
                                'status-success' if log.status == 'success' else 
                                'status-failed' if log.status == 'failed' else 
                                'status-running' 
                            }}">
                                {{ log.result or log.status }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" 
                                    onclick="viewExecutionDetails('{{ log.id }}')">
                                <i class="fas fa-info-circle"></i> 详情
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <i class="fas fa-history" style="font-size: 32px; color: #ddd; margin-bottom: 10px;"></i>
                            <p>暂无执行日志记录</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 执行详情模态框 -->
<div class="modal-backdrop" id="executionDetailsModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title">执行详情</h3>
            <button class="modal-close" onclick="hideModal('executionDetailsModal')">&times;</button>
        </div>
        <div class="modal-body" id="executionDetailsContent">
            <!-- 执行详情内容将通过JavaScript动态加载 -->
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #1a73e8;"></i>
                <p>加载详情中...</p>
            </div>
        </div>
        <div class="modal-footer">
            <button class="btn btn-primary" onclick="hideModal('executionDetailsModal')">关闭</button>
        </div>
    </div>
</div>

<script>
    // 重置筛选条件
    function resetFilters() {
        document.getElementById('plan_id').value = '';
        document.getElementById('status').value = '';
        document.getElementById('filterForm').submit();
    }
    
    // 查看执行详情
    function viewExecutionDetails(logId) {
        // 显示加载状态
        document.getElementById('executionDetailsContent').innerHTML = `
            <div style="text-align: center; padding: 20px;">
                <i class="fas fa-spinner fa-spin" style="font-size: 24px; color: #1a73e8;"></i>
                <p>加载详情中...</p>
            </div>
        `;
        
        // 显示模态框
        showModal('executionDetailsModal');
        
        // 异步获取详情
        fetch(`{{ url_for('log_details', log_id='') }}${logId}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('获取详情失败');
                }
                return response.json();
            })
            .then(log => {
                // 构建详情HTML
                let detailsHtml = `
                    <div class="execution-summary">
                        <p><strong>执行ID：</strong>${log.id}</p>
                        <p><strong>计划名称：</strong>${log.plan_name}</p>
                        <p><strong>执行状态：</strong>
                            <span class="status-badge ${
                                log.status === 'success' ? 'status-success' : 
                                log.status === 'failed' ? 'status-failed' : 'status-running'
                            }">
                                ${log.result || log.status}
                            </span>
                        </p>
                        <p><strong>执行者：</strong>${log.executed_by}</p>
                        <p><strong>开始时间：</strong>${log.started_at}</p>
                        <p><strong>完成时间：</strong>${log.completed_at || '执行中'}</p>
                        ${log.completed_at ? `<p><strong>执行时长：</strong>${calculateDuration(log.started_at, log.completed_at)}</p>` : ''}
                    </div>
                    
                    <div style="margin-top: 20px;">
                        <h4 style="margin-bottom: 10px;">任务执行详情</h4>
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>任务名称</th>
                                    <th>状态</th>
                                    <th>耗时</th>
                                </tr>
                            </thead>
                            <tbody>
                `;
                
                // 添加任务详情
                if (log.details && log.details.length > 0) {
                    log.details.forEach(task => {
                        detailsHtml += `
                            <tr>
                                <td>${task.task}</td>
                                <td>
                                    <span class="status-badge ${task.status === 'success' ? 'status-success' : 'status-failed'}">
                                        ${task.status === 'success' ? '成功' : '失败'}
                                    </span>
                                </td>
                                <td>${task.duration || '-'}</td>
                            </tr>
                        `;
                    });
                } else {
                    detailsHtml += `
                        <tr>
                            <td colspan="3" style="text-align: center;">无任务执行记录</td>
                        </tr>
                    `;
                }
                
                detailsHtml += `
                            </tbody>
                        </table>
                    </div>
                `;
                
                // 更新模态框内容
                document.getElementById('executionDetailsContent').innerHTML = detailsHtml;
            })
            .catch(error => {
                document.getElementById('executionDetailsContent').innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #d93025;">
                        <i class="fas fa-exclamation-circle" style="font-size: 24px;"></i>
                        <p>加载详情失败：${error.message}</p>
                    </div>
                `;
            });
    }
    
    // 计算执行时长
    function calculateDuration(startTime, endTime) {
        const start = new Date(startTime);
        const end = new Date(endTime);
        const diffMs = end - start;
        
        if (diffMs < 1000) {
            return `${diffMs}ms`;
        } else if (diffMs < 60000) {
            return `${(diffMs / 1000).toFixed(1)}s`;
        } else {
            const minutes = Math.floor(diffMs / 60000);
            const seconds = Math.floor((diffMs % 60000) / 1000);
            return `${minutes}m${seconds}s`;
        }
    }
</script>
{% endblock %}
    