{% extends "dashboard.html" %}

{% block title %}环境配置 - 自动化测试平台{% endblock %}

{% block page_title %}环境配置管理{% endblock %}

{% block content %}
<!-- 子菜单导航 -->
<div class="submenu-nav">
    <div class="submenu-items">
        <a href="{{ url_for('database_config_management') }}" class="submenu-item {% if request.endpoint == 'database_config_management' %}active{% endif %}">
            <i class="fas fa-database"></i> 数据库配置
        </a>
        <a href="{{ url_for('test_environment_management') }}" class="submenu-item {% if request.endpoint == 'test_environment_management' %}active{% endif %}">
            <i class="fas fa-server"></i> 测试环境管理
        </a>
    </div>
</div>

<!-- 子页面内容 -->
<div class="env-content">
    {% block env_content %}{% endblock %}
</div>
{% endblock %}

{% block styles %}
<style>
    /* 子菜单导航样式 */
    .submenu-nav {
        background-color: #f8f9fa;
        padding: 15px;
        margin-bottom: 25px;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .submenu-items {
        display: flex;
        gap: 10px;
    }

    .submenu-item {
        padding: 12px 20px;
        border-radius: 6px;
        background-color: #e9ecef;
        color: #495057;
        text-decoration: none;
        font-size: 14px;
        transition: all 0.2s ease;
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .submenu-item:hover {
        background-color: #dee2e6;
        transform: translateY(-2px);
    }

    .submenu-item.active {
        background-color: #1a73e8;
        color: white;
        box-shadow: 0 2px 5px rgba(26, 115, 232, 0.3);
    }

    /* 内容区域 */
    .env-content {
        background-color: white;
        border-radius: 10px;
        box-shadow: 0 2px 15px rgba(0, 0, 0, 0.05);
        padding: 25px;
    }

    /* 卡片样式 */
    .card {
        border: 1px solid #e9ecef;
        border-radius: 8px;
        margin-bottom: 20px;
        box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .card-header {
        padding: 15px 20px;
        background-color: #f8f9fa;
        border-bottom: 1px solid #e9ecef;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }

    .card-title {
        font-size: 18px;
        font-weight: 600;
        margin: 0;
        color: #202124;
    }

    .card-body {
        padding: 20px;
    }

    /* 表格样式 */
    .data-table {
        width: 100%;
        border-collapse: collapse;
    }

    .data-table th,
    .data-table td {
        padding: 12px 15px;
        text-align: left;
        border-bottom: 1px solid #e9ecef;
    }

    .data-table th {
        background-color: #f8f9fa;
        font-weight: 600;
        color: #495057;
    }

    .data-table tr:hover td {
        background-color: #f8f9fa;
    }

    /* 状态标签 */
    .status-badge {
        padding: 4px 10px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
        display: inline-block;
    }

    .status-active {
        background-color: #e6f4ea;
        color: #137333;
    }

    .status-inactive {
        background-color: #fce8e6;
        color: #d93025;
    }

    /* 按钮样式 */
    .btn {
        padding: 8px 16px;
        border-radius: 4px;
        border: none;
        cursor: pointer;
        font-size: 14px;
        display: inline-flex;
        align-items: center;
        gap: 5px;
        transition: all 0.2s ease;
    }

    .btn-primary {
        background-color: #1a73e8;
        color: white;
    }

    .btn-primary:hover {
        background-color: #0d62d9;
        transform: translateY(-2px);
    }

    .btn-outline {
        background-color: transparent;
        border: 1px solid #dee2e6;
        color: #495057;
    }

    .btn-outline:hover {
        background-color: #f8f9fa;
    }

    .btn-sm {
        padding: 6px 12px;
        font-size: 13px;
    }

    .btn-danger {
        background-color: #fce8e6;
        color: #d93025;
    }

    .btn-danger:hover {
        background-color: #fad2cf;
    }

    /* 表单样式 */
    .form-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
        gap: 20px;
        margin-bottom: 20px;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-label {
        display: block;
        margin-bottom: 6px;
        font-weight: 500;
        color: #202124;
    }

    .form-control {
        width: 100%;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.2s;
    }

    .form-control:focus {
        border-color: #1a73e8;
        outline: none;
        box-shadow: 0 0 0 2px rgba(26, 115, 232, 0.2);
    }

    .form-select {
        width: 100%;
        padding: 10px;
        border: 1px solid #dadce0;
        border-radius: 4px;
        background-color: white;
        font-size: 14px;
    }

    /* 空状态 */
    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #5f6368;
    }

    .empty-state i {
        font-size: 48px;
        color: #dadce0;
        margin-bottom: 15px;
    }
</style>
{% endblock %}

{% block scripts %}
<script>
    // 设置侧边栏激活状态
    document.addEventListener('DOMContentLoaded', function() {
        // 高亮环境配置菜单项
        const envMenuItem = document.querySelector('.menu-link[href*="environment_config"]');
        if (envMenuItem) {
            envMenuItem.classList.add('active');
        }

        // 高亮当前子菜单
        document.querySelectorAll('.submenu-item').forEach(item => {
            if (item.href === window.location.href) {
                item.classList.add('active');
            }
        });
    });

    // 显示模态框
    function showModal(modalId) {
        document.getElementById(modalId).style.display = 'block';
    }

    // 隐藏模态框
    function hideModal(modalId) {
        document.getElementById(modalId).style.display = 'none';
    }

    // 编辑测试环境
    function editEnvironment(envId) {
        fetch(`/api/environment/${envId}`)
            .then(response => response.json())
            .then(env => {
                if (env) {
                    document.getElementById('envModalTitle').textContent = '编辑测试环境';
                    document.getElementById('env_id').value = env.id;
                    document.getElementById('env_name').value = env.name;
                    document.getElementById('env_protocol').value = env.protocol;
                    document.getElementById('env_domain').value = env.domain;
                    document.getElementById('env_description').value = env.description || '';
                    document.getElementById('env_status').checked = env.status === 'active';

                    showModal('envModal');
                }
            });
    }

    // 删除测试环境
    function deleteEnvironment(envId) {
        if (confirm('确定要删除该测试环境吗？此操作不可撤销。')) {
            fetch(`/api/environment/${envId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '删除失败');
                }
            });
        }
    }

    // 切换环境状态
    function toggleEnvironmentStatus(envId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const action = newStatus === 'active' ? '启用' : '禁用';

        if (confirm(`确定要${action}该测试环境吗？`)) {
            fetch('/api/environment/toggle_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: envId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '操作失败');
                }
            });
        }
    }
</script>
{% endblock %}