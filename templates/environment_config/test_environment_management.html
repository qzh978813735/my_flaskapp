{% extends "environment_config/base.html" %}

{% block env_content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">测试环境管理</h2>
        <button class="btn btn-primary" onclick="showModal('addEnvironmentModal')">
            <i class="fas fa-plus"></i> 添加测试环境
        </button>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>环境名称</th>
                    <th>环境标识</th>
                    <th>基础URL</th>
                    <th>数据库配置</th>
                    <th>负责人</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% if environments %}
                    {% for env in environments %}
                    <tr>
                        <td>{{ env.name }}</td>
                        <td>{{ env.code }}</td>
                        <td>
                            <a href="{{ env.base_url }}" target="_blank" style="color: #1a73e8;">
                                {{ env.base_url|truncate(30) }}
                            </a>
                        </td>
                        <td>{{ env.db_config_name or '未配置' }}</td>
                        <td>{{ env.owner }}</td>
                        <td>
                            <span class="status-badge {{ 'status-active' if env.status == 'active' else 'status-inactive' }}">
                                {{ '启用' if env.status == 'active' else '禁用' }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="setAsDefault('{{ env.id }}')">
                                {% if env.is_default %}
                                <i class="fas fa-check"></i> 默认环境
                                {% else %}
                                <i class="fas fa-star"></i> 设为默认
                                {% endif %}
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="editEnvironment('{{ env.id }}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="deleteEnvironment('{{ env.id }}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="7" style="text-align: center; padding: 30px;">
                            <i class="fas fa-server" style="font-size: 32px; color: #ddd; margin-bottom: 10px;"></i>
                            <p>暂无测试环境，请添加新环境</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 添加/编辑测试环境模态框 -->
<div class="modal-backdrop" id="addEnvironmentModal">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="environmentModalTitle">添加测试环境</h3>
            <button class="modal-close" onclick="hideModal('addEnvironmentModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="environmentForm" method="POST" action="{{ url_for('test_environment_management') }}">
                <input type="hidden" id="env_id" name="env_id">
                
                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="env_name">环境名称 <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="env_name" name="name" required placeholder="例如：开发环境、测试环境、生产环境">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="env_code">环境标识 <span style="color: red;">*</span></label>
                        <input type="text" class="form-control" id="env_code" name="code" required placeholder="例如：dev、test、prod，用于API调用区分" pattern="[a-zA-Z0-9_]+">
                        <small style="color: #5f6368; font-size: 12px;">只能包含字母、数字和下划线</small>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="base_url">基础URL <span style="color: red;">*</span></label>
                        <input type="url" class="form-control" id="base_url" name="base_url" required placeholder="例如：http://api.test.com:8080">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="db_config">关联数据库配置</label>
                        <select class="form-select" id="db_config" name="db_config_id">
                            <option value="">-- 不关联数据库 --</option>
                            {% for db in databases %}
                            <option value="{{ db.id }}">{{ db.name }} ({{ db.type }})</option>
                            {% endfor %}
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="owner">负责人</label>
                        <input type="text" class="form-control" id="owner" name="owner" placeholder="环境负责人姓名或用户名">
                    </div>
                    
                    <div class="form-group">
                        <label class="form-label" for="contact">联系方式</label>
                        <input type="text" class="form-control" id="contact" name="contact" placeholder="负责人邮箱或电话">
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="env_description">环境描述</label>
                    <textarea class="form-control" id="env_description" name="description" rows="3" placeholder="描述该环境的用途、特点等信息"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-check-label">
                        <input type="checkbox" id="env_status" name="status" checked> 启用该环境
                    </label>
                </div>
                
                <div class="form-group">
                    <label class="form-check-label">
                        <input type="checkbox" id="is_default" name="is_default"> 设为默认环境
                    </label>
                    <small style="color: #5f6368; font-size: 12px;">默认环境将作为测试执行的首选环境</small>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="hideModal('addEnvironmentModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存环境</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 编辑测试环境
    function editEnvironment(envId) {
        // 模拟获取环境数据
        const env = {{ environments|tojson }}.find(e => e.id === envId);
        if (!env) return;
        
        // 填充表单数据
        document.getElementById('environmentModalTitle').textContent = '编辑测试环境';
        document.getElementById('env_id').value = env.id;
        document.getElementById('env_name').value = env.name;
        document.getElementById('env_code').value = env.code;
        document.getElementById('base_url').value = env.base_url;
        document.getElementById('db_config').value = env.db_config_id || '';
        document.getElementById('owner').value = env.owner || '';
        document.getElementById('contact').value = env.contact || '';
        document.getElementById('env_description').value = env.description || '';
        document.getElementById('env_status').checked = env.status === 'active';
        document.getElementById('is_default').checked = env.is_default;
        
        // 显示模态框
        showModal('addEnvironmentModal');
    }
    
    // 设置为默认环境
    function setAsDefault(envId) {
        // 检查是否已经是默认环境
        const env = {{ environments|tojson }}.find(e => e.id === envId);
        if (env && env.is_default) {
            alert('该环境已经是默认环境');
            return;
        }
        
        if (confirm('确定要将此环境设为默认环境吗？\n默认环境将作为测试执行的首选环境。')) {
            // 实际项目中应发送AJAX请求到后端
            window.location.href = "{{ url_for('test_environment_management') }}?action=set_default&env_id=" + envId;
        }
    }
    
    // 删除测试环境
    function deleteEnvironment(envId) {
        // 检查是否是默认环境
        const env = {{ environments|tojson }}.find(e => e.id === envId);
        if (env && env.is_default) {
            alert('不能删除默认环境，请先将其他环境设为默认环境');
            return;
        }
        
        if (confirm('确定要删除该测试环境吗？此操作不可撤销。')) {
            // 实际项目中应发送AJAX请求到后端
            window.location.href = "{{ url_for('test_environment_management') }}?action=delete&env_id=" + envId;
        }
    }
</script>
{% endblock %}
