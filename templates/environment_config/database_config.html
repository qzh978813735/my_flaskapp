{% extends "environment_config/base.html" %}

{% block env_content %}
<div class="card">
    <div class="card-header">
        <h2 class="card-title">数据库配置管理</h2>
        <button class="btn btn-primary" onclick="showModal('dbModal')">
            <i class="fas fa-plus"></i> 添加数据库配置
        </button>
    </div>
    <div class="card-body">
        <table class="data-table">
            <thead>
                <tr>
                    <th>配置名称</th>
                    <th>数据库类型</th>
                    <th>描述</th>
                    <th>状态</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody>
                {% if db_configs %}
                    {% for db in db_configs %}
                    <tr>
                        <td>{{ db.name }}</td>
                        <td>{{ db.type }}</td>
                        <td>{{ db.description|truncate(30) }}</td>
                        <td>
                            <span class="status-badge {{ 'status-active' if db.status == 'active' else 'status-inactive' }}">
                                {{ '启用' if db.status == 'active' else '禁用' }}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="toggleDBStatus('{{ db.id }}', '{{ db.status }}')">
                                <i class="fas {{ 'fa-toggle-on' if db.status == 'active' else 'fa-toggle-off' }}"></i>
                                {{ '禁用' if db.status == 'active' else '启用' }}
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="editDB('{{ db.id }}')">
                                <i class="fas fa-edit"></i> 编辑
                            </button>
                            <a href="{{ url_for('db_connection_info', db_id=db.id) }}" class="btn btn-outline btn-sm">
                                <i class="fas fa-plug"></i> 连接配置
                            </a>
                            <button class="btn btn-danger btn-sm" onclick="deleteDB('{{ db.id }}')">
                                <i class="fas fa-trash"></i> 删除
                            </button>
                        </td>
                    </tr>
                    {% endfor %}
                {% else %}
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-database"></i>
                            <p>暂无数据库配置，请添加新配置</p>
                        </td>
                    </tr>
                {% endif %}
            </tbody>
        </table>
    </div>
</div>

<!-- 添加/编辑数据库配置模态框 -->
<div class="modal-backdrop" id="dbModal" style="display:none;">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title" id="dbModalTitle">添加数据库配置</h3>
            <button class="modal-close" onclick="hideModal('dbModal')">&times;</button>
        </div>
        <div class="modal-body">
            <form id="databaseForm" method="POST" action="{{ url_for('database_config_management') }}">
                <input type="hidden" id="db_id" name="id">

                <div class="form-grid">
                    <div class="form-group">
                        <label class="form-label" for="db_name">配置名称 *</label>
                        <input type="text" class="form-control" id="db_name" name="name" required
                               placeholder="例如：用户数据库、产品数据库">
                    </div>

                    <div class="form-group">
                        <label class="form-label" for="db_type">数据库类型 *</label>
                        <select class="form-select" id="db_type" name="type" required>
                            <option value="">请选择数据库类型</option>
                            <option value="MySQL">MySQL</option>
                            <option value="PostgreSQL">PostgreSQL</option>
                            <option value="SQL Server">SQL Server</option>
                            <option value="Oracle">Oracle</option>
                            <option value="MongoDB">MongoDB</option>
                            <option value="Redis">Redis</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" for="db_description">描述</label>
                    <textarea class="form-control" id="db_description" name="description" rows="3"
                              placeholder="描述该数据库的用途等信息"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-check-label">
                        <input type="checkbox" id="db_status" name="status" checked> 启用该配置
                    </label>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-outline" onclick="hideModal('dbModal')">取消</button>
                    <button type="submit" class="btn btn-primary">保存配置</button>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    // 编辑数据库配置
    function editDB(dbId) {
        fetch(`/api/database/${dbId}`)
            .then(response => response.json())
            .then(db => {
                if (db) {
                    document.getElementById('dbModalTitle').textContent = '编辑数据库配置';
                    document.getElementById('db_id').value = db.id;
                    document.getElementById('db_name').value = db.name;
                    document.getElementById('db_type').value = db.type;
                    document.getElementById('db_description').value = db.description || '';
                    document.getElementById('db_status').checked = db.status === 'active';

                    showModal('dbModal');
                }
            });
    }

    // 删除数据库配置
    function deleteDB(dbId) {
        if (confirm('确定要删除该数据库配置吗？此操作不可撤销。')) {
            fetch(`/api/database/${dbId}`, {
                method: 'DELETE'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '删除失败');
                }
            });
        }
    }

    // 切换数据库状态
    function toggleDBStatus(dbId, currentStatus) {
        const newStatus = currentStatus === 'active' ? 'inactive' : 'active';
        const action = newStatus === 'active' ? '启用' : '禁用';

        if (confirm(`确定要${action}该数据库配置吗？`)) {
            fetch('/api/database/toggle_status', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({
                    id: dbId,
                    status: newStatus
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    location.reload();
                } else {
                    alert(data.message || '操作失败');
                }
            });
        }
    }
</script>
{% endblock %}